{"version":3,"file":"flagged-functions.js","names":["ensureNotFalsy","rx_pipeline_fn_1_","fn","rx_pipeline_fn_2_","rx_pipeline_fn_3_","rx_pipeline_fn_4_","rx_pipeline_fn_5_","rx_pipeline_fn_6_","rx_pipeline_fn_7_","rx_pipeline_fn_8_","rx_pipeline_fn_9_","rx_pipeline_fn_10_","rx_pipeline_fn_11_","rx_pipeline_fn_12_","rx_pipeline_fn_13_","rx_pipeline_fn_14_","rx_pipeline_fn_15_","rx_pipeline_fn_16_","rx_pipeline_fn_17_","rx_pipeline_fn_18_","rx_pipeline_fn_19_","rx_pipeline_fn_20_","FLAGGED_FUNCTIONS","ids","Object","keys","blockFlaggedFunctionKey","id","pop","releaseFlaggedFunctionKey","key","push"],"sources":["../../../../src/plugins/pipeline/flagged-functions.ts"],"sourcesContent":["import { ensureNotFalsy } from '../utils/index.ts';\n\n/**\n * This is the most hacky thing we do in RxDB.\n * When a pipeline \"transaction\" is running,\n * we have to make all calls to the collection from the outside\n * wait while still make it possible to run reads and writes\n * from inside the transaction.\n * \n * We can decide where the call came from by checking the stack `new Error().stack`\n * for a random \"flag\".\n * But creating random flagged functions requires eval which we should not use.\n * Instead we have a list of some flagged functions here\n * that can be used and checked for in the stacktrace.\n * \n * \n * When doing this with eval() instead it would look like:\n * ```ts\n * eval(`\n *     async function ${this.secretFunctionName}(docs){ const x = await _this.handler(docs); return x; }\n *     o.${this.secretFunctionName} = ${this.secretFunctionName};\n *   `);\n * await o[this.secretFunctionName](rxDocuments);\n * \n * ```\n */\nasync function rx_pipeline_fn_1_(fn: any) {\n    return await fn();\n}\nasync function rx_pipeline_fn_2_(fn: any) {\n    return await fn();\n}\nasync function rx_pipeline_fn_3_(fn: any) {\n    return await fn();\n}\nasync function rx_pipeline_fn_4_(fn: any) {\n    return await fn();\n}\nasync function rx_pipeline_fn_5_(fn: any) {\n    return await fn();\n}\nasync function rx_pipeline_fn_6_(fn: any) {\n    return await fn();\n}\nasync function rx_pipeline_fn_7_(fn: any) {\n    return await fn();\n}\nasync function rx_pipeline_fn_8_(fn: any) {\n    return await fn();\n}\nasync function rx_pipeline_fn_9_(fn: any) {\n    return await fn();\n}\nasync function rx_pipeline_fn_10_(fn: any) {\n    return await fn();\n}\nasync function rx_pipeline_fn_11_(fn: any) {\n    return await fn();\n}\nasync function rx_pipeline_fn_12_(fn: any) {\n    return await fn();\n}\nasync function rx_pipeline_fn_13_(fn: any) {\n    return await fn();\n}\nasync function rx_pipeline_fn_14_(fn: any) {\n    return await fn();\n}\nasync function rx_pipeline_fn_15_(fn: any) {\n    return await fn();\n}\nasync function rx_pipeline_fn_16_(fn: any) {\n    return await fn();\n}\nasync function rx_pipeline_fn_17_(fn: any) {\n    return await fn();\n}\nasync function rx_pipeline_fn_18_(fn: any) {\n    return await fn();\n}\nasync function rx_pipeline_fn_19_(fn: any) {\n    return await fn();\n}\nasync function rx_pipeline_fn_20_(fn: any) {\n    return await fn();\n}\n\n\n\n\n\nexport const FLAGGED_FUNCTIONS = {\n    rx_pipeline_fn_1_,\n    rx_pipeline_fn_2_,\n    rx_pipeline_fn_3_,\n    rx_pipeline_fn_4_,\n    rx_pipeline_fn_5_,\n    rx_pipeline_fn_6_,\n    rx_pipeline_fn_7_,\n    rx_pipeline_fn_8_,\n    rx_pipeline_fn_9_,\n    rx_pipeline_fn_10_,\n    rx_pipeline_fn_11_,\n    rx_pipeline_fn_12_,\n    rx_pipeline_fn_13_,\n    rx_pipeline_fn_14_,\n    rx_pipeline_fn_15_,\n    rx_pipeline_fn_16_,\n    rx_pipeline_fn_17_,\n    rx_pipeline_fn_18_,\n    rx_pipeline_fn_19_,\n    rx_pipeline_fn_20_,\n} as const;\n\n\n\nconst ids: (keyof typeof FLAGGED_FUNCTIONS)[] = Object.keys(FLAGGED_FUNCTIONS) as any;\n\nexport function blockFlaggedFunctionKey(): keyof typeof FLAGGED_FUNCTIONS {\n    /**\n     * If this happens and we have no more flagged keys left\n     * it means that more pipeline handlers are running in parallel.\n     * To fix this, add more functions.\n     */\n    const id = ensureNotFalsy(ids.pop(), 'no flagged keys left');\n    return id;\n}\n\nexport function releaseFlaggedFunctionKey(key: keyof typeof FLAGGED_FUNCTIONS) {\n    ids.push(key);\n}\n"],"mappings":"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","ignoreList":[]}