{"version":3,"file":"local-documents-helper.js","names":["filter","map","DocumentCache","IncrementalWriteQueue","newRxError","fillWithDefaultSettings","getWrappedStorageInstance","randomCouchString","createRxLocalDocument","overwritable","LOCAL_DOC_STATE_BY_PARENT","WeakMap","LOCAL_DOC_STATE_BY_PARENT_RESOLVED","createLocalDocStateByParent","parent","database","collectionName","name","statePromise","storageInstance","createLocalDocumentStorageInstance","token","storage","instanceCreationOptions","multiInstance","RX_LOCAL_DOCUMENT_SCHEMA","docCache","eventBulks$","pipe","changeEventBulk","ret","events","isLocal","b","docData","incrementalWriteQueue","databaseStorageToken","storageToken","subLocalDocs","changeStream","subscribe","eventBulk","Array","length","rawEvents","undefined","index","event","documentId","operation","documentData","deepFreezeWhenDevMode","previousDocumentData","id","internal","databaseToken","checkpoint","context","endTime","startTime","$emit","_subs","push","state","set","getLocalDocStateByParent","get","collection","databaseInstanceToken","databaseName","createStorageInstance","getCollectionLocalInstanceName","schema","options","devMode","isDevMode","closeStateByParent","delete","then","close","removeLocalDocumentsStorageInstance","remove","title","version","primaryKey","type","properties","maxLength","data","additionalProperties","required"],"sources":["../../../../src/plugins/local-documents/local-documents-helper.ts"],"sourcesContent":["import { filter, map } from 'rxjs';\nimport { DocumentCache } from '../../doc-cache.ts';\nimport { IncrementalWriteQueue } from '../../incremental-write.ts';\nimport { newRxError } from '../../rx-error.ts';\nimport { fillWithDefaultSettings } from '../../rx-schema-helper.ts';\nimport {\n    getWrappedStorageInstance\n} from '../../rx-storage-helper.ts';\nimport type {\n    LocalDocumentParent,\n    LocalDocumentState,\n    RxChangeEvent,\n    RxChangeEventBulk,\n    RxDatabase,\n    RxDocumentData,\n    RxJsonSchema,\n    RxLocalDocumentData,\n    RxStorage\n} from '../../types/index.d.ts';\nimport { randomCouchString } from '../../plugins/utils/index.ts';\nimport { createRxLocalDocument } from './rx-local-document.ts';\nimport { overwritable } from '../../overwritable.ts';\n\nexport const LOCAL_DOC_STATE_BY_PARENT: WeakMap<LocalDocumentParent, Promise<LocalDocumentState>> = new WeakMap();\nexport const LOCAL_DOC_STATE_BY_PARENT_RESOLVED: WeakMap<LocalDocumentParent, LocalDocumentState> = new WeakMap();\n\nexport function createLocalDocStateByParent(parent: LocalDocumentParent): void {\n    const database: RxDatabase = parent.database ? parent.database : parent as any;\n    const collectionName = parent.database ? parent.name : '';\n    const statePromise = (async () => {\n        let storageInstance = await createLocalDocumentStorageInstance(\n            database.token,\n            database.storage,\n            database.name,\n            collectionName,\n            database.instanceCreationOptions,\n            database.multiInstance\n        );\n        storageInstance = getWrappedStorageInstance(\n            database,\n            storageInstance,\n            RX_LOCAL_DOCUMENT_SCHEMA\n        );\n\n        const docCache = new DocumentCache<RxLocalDocumentData, {}>(\n            'id',\n            database.eventBulks$.pipe(\n                filter(changeEventBulk => {\n                    let ret = false;\n                    if (\n                        // parent is database\n                        (\n                            collectionName === '' &&\n                            !changeEventBulk.collectionName\n                        ) ||\n                        // parent is collection\n                        (\n                            collectionName !== '' &&\n                            changeEventBulk.collectionName === collectionName\n                        )\n                    ) {\n                        ret = true;\n                    }\n                    return ret && changeEventBulk.events[0].isLocal;\n                }),\n                map(b => b.events)\n            ),\n            docData => createRxLocalDocument(docData, parent) as any\n        );\n\n        const incrementalWriteQueue = new IncrementalWriteQueue(\n            storageInstance,\n            'id',\n            () => { },\n            () => { }\n        );\n\n        /**\n         * Emit the changestream into the collections change stream\n         */\n        const databaseStorageToken = await database.storageToken;\n        const subLocalDocs = storageInstance.changeStream().subscribe(eventBulk => {\n            const events = new Array(eventBulk.events.length);\n            const rawEvents = eventBulk.events;\n            const collectionName = parent.database ? parent.name : undefined;\n            for (let index = 0; index < rawEvents.length; index++) {\n                const event = rawEvents[index];\n                events[index] = {\n                    documentId: event.documentId,\n                    collectionName,\n                    isLocal: true,\n                    operation: event.operation,\n                    documentData: overwritable.deepFreezeWhenDevMode(event.documentData) as any,\n                    previousDocumentData: overwritable.deepFreezeWhenDevMode(event.previousDocumentData) as any\n                };\n            }\n            const changeEventBulk: RxChangeEventBulk<RxLocalDocumentData> = {\n                id: eventBulk.id,\n                internal: false,\n                collectionName: parent.database ? parent.name : undefined,\n                storageToken: databaseStorageToken,\n                events,\n                databaseToken: database.token,\n                checkpoint: eventBulk.checkpoint,\n                context: eventBulk.context,\n                endTime: eventBulk.endTime,\n                startTime: eventBulk.startTime\n            };\n            database.$emit(changeEventBulk);\n        });\n        parent._subs.push(subLocalDocs);\n\n        const state = {\n            database,\n            parent,\n            storageInstance,\n            docCache,\n            incrementalWriteQueue\n        };\n        LOCAL_DOC_STATE_BY_PARENT_RESOLVED.set(parent, state);\n        return state;\n    })();\n    LOCAL_DOC_STATE_BY_PARENT.set(parent, statePromise);\n}\n\nexport function getLocalDocStateByParent(parent: LocalDocumentParent): Promise<LocalDocumentState> {\n    const statePromise = LOCAL_DOC_STATE_BY_PARENT.get(parent);\n    if (!statePromise) {\n        const database: RxDatabase = parent.database ? parent.database : parent as any;\n        const collectionName = parent.database ? parent.name : '';\n        throw newRxError('LD8', {\n            database: database.name,\n            collection: collectionName\n        });\n    }\n    return statePromise;\n}\n\nexport function createLocalDocumentStorageInstance(\n    databaseInstanceToken: string,\n    storage: RxStorage<any, any>,\n    databaseName: string,\n    collectionName: string,\n    instanceCreationOptions: any,\n    multiInstance: boolean\n) {\n    return storage.createStorageInstance<RxLocalDocumentData>({\n        databaseInstanceToken,\n        databaseName: databaseName,\n        /**\n         * Use a different collection name for the local documents instance\n         * so that the local docs can be kept while deleting the normal instance\n         * after migration.\n         */\n        collectionName: getCollectionLocalInstanceName(collectionName),\n        schema: RX_LOCAL_DOCUMENT_SCHEMA,\n        options: instanceCreationOptions,\n        multiInstance,\n        devMode: overwritable.isDevMode()\n    });\n}\n\nexport function closeStateByParent(parent: LocalDocumentParent) {\n    const statePromise = LOCAL_DOC_STATE_BY_PARENT.get(parent);\n    if (statePromise) {\n        LOCAL_DOC_STATE_BY_PARENT.delete(parent);\n        return statePromise.then(state => state.storageInstance.close());\n    }\n}\n\nexport async function removeLocalDocumentsStorageInstance(\n    storage: RxStorage<any, any>,\n    databaseName: string,\n    collectionName: string\n) {\n    const databaseInstanceToken = randomCouchString(10);\n    const storageInstance = await createLocalDocumentStorageInstance(\n        databaseInstanceToken,\n        storage,\n        databaseName,\n        collectionName,\n        {},\n        false\n    );\n    await storageInstance.remove();\n}\n\nexport function getCollectionLocalInstanceName(collectionName: string): string {\n    return 'plugin-local-documents-' + collectionName;\n}\n\nexport const RX_LOCAL_DOCUMENT_SCHEMA: RxJsonSchema<RxDocumentData<RxLocalDocumentData>> = fillWithDefaultSettings({\n    title: 'RxLocalDocument',\n    version: 0,\n    primaryKey: 'id',\n    type: 'object',\n    properties: {\n        id: {\n            type: 'string',\n            maxLength: 128\n        },\n        data: {\n            type: 'object',\n            additionalProperties: true\n        }\n    },\n    required: [\n        'id',\n        'data'\n    ]\n});\n"],"mappings":"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","ignoreList":[]}