{"version":3,"file":"check-document.js","names":["_rxError","require","_rxSchemaHelper","ensurePrimaryKeyValid","primaryKey","docData","newRxError","document","trim","includes","containsDateInstance","obj","key","hasOwnProperty","Date","checkWriteRows","storageInstance","rows","primaryPath","getPrimaryFieldOfPrimaryKey","schema","_loop","writeRow","fillPrimaryKey","previous","Object","keys","_meta","forEach","metaFieldName","prototype","call","dataBefore","dataAfter","args","structuredClone","JSON","parse","stringify","err","collection","collectionName"],"sources":["../../../../src/plugins/dev-mode/check-document.ts"],"sourcesContent":["import { newRxError } from '../../rx-error.ts';\nimport { fillPrimaryKey, getPrimaryFieldOfPrimaryKey } from '../../rx-schema-helper.ts';\nimport type { BulkWriteRow, RxDocumentData, RxStorageInstance } from '../../types/index.d.ts';\n\nexport function ensurePrimaryKeyValid(\n    primaryKey: string,\n    docData: RxDocumentData<any>\n) {\n    if (!primaryKey) {\n        throw newRxError('DOC20', {\n            primaryKey,\n            document: docData\n        });\n    }\n\n\n    /**\n     * This is required so that we can left-pad\n     * the primaryKey and we are still able to de-left-pad\n     * it to get again the original key.\n     */\n    if (\n        primaryKey !== primaryKey.trim()\n    ) {\n        throw newRxError('DOC21', {\n            primaryKey,\n            document: docData\n        });\n    }\n    if (\n        primaryKey.includes('\\r') ||\n        primaryKey.includes('\\n')\n    ) {\n        throw newRxError('DOC22', {\n            primaryKey,\n            document: docData\n        });\n    }\n    if (\n        primaryKey.includes('\"')\n    ) {\n        throw newRxError('DOC23', {\n            primaryKey,\n            document: docData\n        });\n    }\n}\n\n/**\n * Deeply checks if the object contains an\n * instance of the JavaScript Date class.\n * @recursive\n */\nexport function containsDateInstance(obj: any): boolean {\n    if (typeof obj !== 'object' || obj === null) {\n        return false;\n    }\n    for (let key in obj) {\n        if (obj.hasOwnProperty(key)) {\n            if (obj[key] instanceof Date) {\n                return true;\n            }\n            if (typeof obj[key] === 'object' && containsDateInstance(obj[key])) {\n                return true;\n            }\n        }\n    }\n    return false;\n}\n\n\nexport function checkWriteRows<RxDocType>(\n    storageInstance: RxStorageInstance<RxDocType, any, any, any>,\n    rows: BulkWriteRow<RxDocType>[]\n) {\n    const primaryPath = getPrimaryFieldOfPrimaryKey(storageInstance.schema.primaryKey);\n    for (const writeRow of rows) {\n        // ensure that the primary key has not been changed\n        writeRow.document = fillPrimaryKey(\n            primaryPath,\n            storageInstance.schema,\n            writeRow.document\n        );\n\n\n\n        /**\n         * Ensure that _meta fields have been merged\n         * and not replaced.\n         * This is important so that when one plugin A\n         * sets a _meta field and another plugin B does a write\n         * to the document, it must be ensured that the\n         * field of plugin A was not removed.\n         */\n        if (writeRow.previous) {\n            Object.keys(writeRow.previous._meta)\n                .forEach(metaFieldName => {\n                    if (!Object.prototype.hasOwnProperty.call(writeRow.document._meta, metaFieldName)) {\n                        throw newRxError('SNH', {\n                            dataBefore: writeRow.previous,\n                            dataAfter: writeRow.document,\n                            args: {\n                                metaFieldName\n                            }\n                        });\n                    }\n                });\n        }\n\n        /**\n         * Ensure it can be structured cloned\n         */\n        try {\n            /**\n             * Notice that structuredClone() is not available\n             * in ReactNative, so we test for JSON.stringify() instead\n             * @link https://github.com/pubkey/rxdb/issues/5046#issuecomment-1827374498\n             */\n            if (typeof structuredClone === 'function') {\n                structuredClone(writeRow);\n            } else {\n                JSON.parse(JSON.stringify(writeRow));\n            }\n        } catch (err) {\n            throw newRxError('DOC24', {\n                collection: storageInstance.collectionName,\n                document: writeRow.document\n            });\n        }\n\n\n        /**\n         * Ensure it does not contain a Date() object\n         */\n        if (containsDateInstance(writeRow.document)) {\n            throw newRxError('DOC24', {\n                collection: storageInstance.collectionName,\n                document: writeRow.document\n            });\n        }\n    }\n\n}\n"],"mappings":"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","ignoreList":[]}