{"version":3,"file":"rx-storage-instance-denokv.js","names":["_rxjs","require","_rxSchemaHelper","_rxStorageMultiinstance","_denokvHelper","_customIndex","_utilsArray","_utilsOther","_rxStorageHelper","_utilsTime","_denokvQuery","_queryPlanner","_utilsPromise","_utilsObject","RxStorageInstanceDenoKV","exports","storage","databaseName","collectionName","schema","internals","options","settings","keySpace","version","join","kvOptions","consistency","consistencyLevel","changes$","Subject","primaryPath","getPrimaryFieldOfPrimaryKey","primaryKey","kvPromise","getDenoGlobal","openKv","openKvPath","then","kv","set","_proto","prototype","retryUntilNoWriteInBetween","fn","writeBlockKeyBefore","get","writeBlockValueBefore","value","result","writeBlockKeyAfter","writeBlockValueAfter","bulkWrite","documentWrites","context","_this","ret","error","batches","batchArray","ensureNotFalsy","batchSize","writeBatch","_loop","writeBlockKey","docsInDB","Map","readManyBatches","Promise","all","map","readManyBatch","docsResult","getMany","writeRow","docId","document","DENOKV_DOCUMENT_ROOT_PATH","row","docData","categorized","categorizeBulkWriteRows","tx","atomic","check","bulkInsertDocs","forEach","Object","values","indexes","indexMeta","indexString","getIndexableString","indexId","bulkUpdateDocs","oldIndexString","previous","newIndexString","delete","txResult","commit","err","message","includes","ok","appendToArray","errors","eventBulk","events","length","lastState","newestRow","checkpoint","id","lwt","_meta","endTime","now","next","findDocumentsById","ids","withDeleted","kvKey","findSingleResult","docInDb","_deleted","push","query","preparedQuery","queryDenoKV","count","documents","mode","getAttachmentData","documentId","attachmentId","digest","Error","changeStream","asObservable","cleanup","minimumDeletedTime","_this2","maxDeletionTime","index","CLEANUP_INDEX","indexName","getDenoKVIndexName","lowerBoundString","getStartIndexStringFromLowerBound","upperBoundString","noMoreUndeleted","range","list","start","end","limit","rangeCount","_loop2","docDataResult","indexMetaInner","_ret","close","closed","complete","remove","ensureNotClosed","INDEX_MAX","promises","key","conflictResultionTasks","resolveConflictResultionTask","_taskSolution","PROMISE_RESOLVE_VOID","createDenoKVStorageInstance","params","flatClone","indexDBs","useIndexes","slice","useIndexesFinal","indexAr","toArray","getIndexableStringMonad","instance","addRxStorageMultiInstanceSupport","RX_STORAGE_NAME_DENOKV","resolve"],"sources":["../../../../src/plugins/storage-denokv/rx-storage-instance-denokv.ts"],"sourcesContent":["\nimport {\n    Subject,\n    Observable\n} from 'rxjs';\nimport type {\n    RxStorageInstance,\n    RxStorageChangeEvent,\n    RxDocumentData,\n    BulkWriteRow,\n    RxStorageBulkWriteResponse,\n    RxStorageQueryResult,\n    RxJsonSchema,\n    RxStorageInstanceCreationParams,\n    EventBulk,\n    StringKeys,\n    RxConflictResultionTaskSolution,\n    RxStorageDefaultCheckpoint,\n    RxStorageCountResult,\n    RxConflictResultionTask,\n    PreparedQuery\n} from '../../types/index.d.ts';\nimport { getPrimaryFieldOfPrimaryKey } from '../../rx-schema-helper.ts';\nimport { addRxStorageMultiInstanceSupport } from '../../rx-storage-multiinstance.ts';\nimport type { DenoKVIndexMeta, DenoKVSettings, DenoKVStorageInternals } from './denokv-types.ts';\nimport { RxStorageDenoKV } from './index.ts';\nimport { CLEANUP_INDEX, DENOKV_DOCUMENT_ROOT_PATH, RX_STORAGE_NAME_DENOKV, getDenoGlobal, getDenoKVIndexName } from \"./denokv-helper.ts\";\nimport { getIndexableStringMonad, getStartIndexStringFromLowerBound } from \"../../custom-index.ts\";\nimport { appendToArray, batchArray, lastOfArray, toArray } from \"../utils/utils-array.ts\";\nimport { ensureNotFalsy } from \"../utils/utils-other.ts\";\nimport { categorizeBulkWriteRows } from \"../../rx-storage-helper.ts\";\nimport { now } from \"../utils/utils-time.ts\";\nimport { queryDenoKV } from \"./denokv-query.ts\";\nimport { INDEX_MAX } from \"../../query-planner.ts\";\nimport { PROMISE_RESOLVE_VOID } from \"../utils/utils-promise.ts\";\nimport { flatClone } from \"../utils/utils-object.ts\";\n\n\n\nexport class RxStorageInstanceDenoKV<RxDocType> implements RxStorageInstance<\n    RxDocType,\n    DenoKVStorageInternals<RxDocType>,\n    DenoKVSettings,\n    RxStorageDefaultCheckpoint\n> {\n    public readonly primaryPath: StringKeys<RxDocumentData<RxDocType>>;\n    private changes$: Subject<EventBulk<RxStorageChangeEvent<RxDocumentData<RxDocType>>, RxStorageDefaultCheckpoint>> = new Subject();\n    public closed?: Promise<void>;\n    public readonly kvPromise: Promise<any>;\n\n    constructor(\n        public readonly storage: RxStorageDenoKV,\n        public readonly databaseName: string,\n        public readonly collectionName: string,\n        public readonly schema: Readonly<RxJsonSchema<RxDocumentData<RxDocType>>>,\n        public readonly internals: DenoKVStorageInternals<RxDocType>,\n        public readonly options: Readonly<DenoKVSettings>,\n        public readonly settings: DenoKVSettings,\n        public readonly keySpace = ['rxdb', databaseName, collectionName, schema.version].join('|'),\n        public readonly kvOptions = { consistency: settings.consistencyLevel }\n    ) {\n        this.primaryPath = getPrimaryFieldOfPrimaryKey(this.schema.primaryKey);\n        this.kvPromise = getDenoGlobal().openKv(settings.openKvPath).then(async (kv: any) => {\n            // insert writeBlockKey\n            await kv.set([this.keySpace], 1);\n            return kv;\n        });\n    }\n\n    /**\n     * DenoKV has no transactions\n     * so we have to ensure that there is no write in between our queries\n     * which would confuse RxDB and return wrong query results.\n     */\n    async retryUntilNoWriteInBetween<T>(\n        fn: () => Promise<T>\n    ): Promise<T> {\n        const kv = await this.kvPromise;\n        while (true) {\n            const writeBlockKeyBefore = await kv.get([this.keySpace], this.kvOptions);\n            const writeBlockValueBefore = writeBlockKeyBefore ? writeBlockKeyBefore.value : -1;\n            const result = await fn();\n            const writeBlockKeyAfter = await kv.get([this.keySpace], this.kvOptions);\n            const writeBlockValueAfter = writeBlockKeyAfter ? writeBlockKeyAfter.value : -1;\n\n            if (writeBlockValueBefore === writeBlockValueAfter) {\n                return result;\n            }\n        }\n    }\n\n    async bulkWrite(documentWrites: BulkWriteRow<RxDocType>[], context: string): Promise<RxStorageBulkWriteResponse<RxDocType>> {\n        const kv = await this.kvPromise;\n        const primaryPath = this.primaryPath;\n        const ret: RxStorageBulkWriteResponse<RxDocType> = {\n            error: []\n        };\n\n        const batches = batchArray(documentWrites, ensureNotFalsy(this.settings.batchSize));\n\n        /**\n         * DenoKV does not have transactions\n         * so we use a special writeBlock row to ensure\n         * atomic writes (per document)\n         * and so that we can do bulkWrites\n         */\n        for (const writeBatch of batches) {\n            while (true) {\n                const writeBlockKey = await kv.get([this.keySpace], this.kvOptions);\n                const docsInDB = new Map<string, RxDocumentData<RxDocType>>();\n\n                /**\n                 * TODO the max amount for .getMany() is 10 which is defined by deno itself.\n                 * How can this be increased?\n                 */\n                const readManyBatches = batchArray(writeBatch, 10);\n                await Promise.all(\n                    readManyBatches.map(async (readManyBatch) => {\n                        const docsResult = await kv.getMany(\n                            readManyBatch.map(writeRow => {\n                                const docId: string = writeRow.document[primaryPath] as any;\n                                return [this.keySpace, DENOKV_DOCUMENT_ROOT_PATH, docId];\n                            })\n                        );\n                        docsResult.map((row: any) => {\n                            const docData = row.value;\n                            if (!docData) {\n                                return;\n                            }\n                            const docId: string = docData[primaryPath] as any;\n                            docsInDB.set(docId, docData);\n                        });\n                    })\n                );\n                const categorized = categorizeBulkWriteRows<RxDocType>(\n                    this,\n                    this.primaryPath as any,\n                    docsInDB,\n                    writeBatch,\n                    context\n                );\n\n                let tx = kv.atomic();\n                tx = tx.set([this.keySpace], ensureNotFalsy(writeBlockKey.value) + 1);\n                tx = tx.check(writeBlockKey);\n\n                // INSERTS\n                categorized.bulkInsertDocs.forEach(writeRow => {\n                    const docId: string = writeRow.document[this.primaryPath] as any;\n\n                    // insert document data\n                    tx = tx.set([this.keySpace, DENOKV_DOCUMENT_ROOT_PATH, docId], writeRow.document);\n\n                    // insert secondary indexes\n                    Object.values(this.internals.indexes).forEach(indexMeta => {\n                        const indexString = indexMeta.getIndexableString(writeRow.document as any);\n                        tx = tx.set([this.keySpace, indexMeta.indexId, indexString], docId);\n                    });\n                });\n                // UPDATES\n                categorized.bulkUpdateDocs.forEach((writeRow: BulkWriteRow<RxDocType>) => {\n                    const docId: string = writeRow.document[this.primaryPath] as any;\n\n                    // insert document data\n                    tx = tx.set([this.keySpace, DENOKV_DOCUMENT_ROOT_PATH, docId], writeRow.document);\n\n                    // insert secondary indexes\n                    Object.values(this.internals.indexes).forEach(indexMeta => {\n                        const oldIndexString = indexMeta.getIndexableString(ensureNotFalsy(writeRow.previous));\n                        const newIndexString = indexMeta.getIndexableString(writeRow.document as any);\n                        if (oldIndexString !== newIndexString) {\n                            tx = tx.delete([this.keySpace, indexMeta.indexId, oldIndexString]);\n                            tx = tx.set([this.keySpace, indexMeta.indexId, newIndexString], docId);\n                        }\n                    });\n                });\n\n                let txResult;\n                try {\n                    txResult = await tx.commit();\n                } catch (err: any) {\n                    if (\n                        err.message.includes('Error code 5:') ||\n                        err.message.includes('Error code 517:')\n                    ) {\n                        // retry\n                    } else {\n                        throw err;\n                    }\n                }\n                if (txResult && txResult.ok) {\n                    appendToArray(ret.error, categorized.errors);\n                    if (categorized.eventBulk.events.length > 0) {\n                        const lastState = ensureNotFalsy(categorized.newestRow).document;\n                        categorized.eventBulk.checkpoint = {\n                            id: lastState[primaryPath],\n                            lwt: lastState._meta.lwt\n                        };\n                        categorized.eventBulk.endTime = now();\n                        this.changes$.next(categorized.eventBulk);\n                    }\n                    break;\n                }\n            }\n        }\n        return ret;\n    }\n    async findDocumentsById(ids: string[], withDeleted: boolean): Promise<RxDocumentData<RxDocType>[]> {\n        const kv = await this.kvPromise;\n        const ret: RxDocumentData<RxDocType>[] = [];\n        await Promise.all(\n            ids.map(async (docId) => {\n                const kvKey = [this.keySpace, DENOKV_DOCUMENT_ROOT_PATH, docId];\n                const findSingleResult = await kv.get(kvKey, this.kvOptions);\n                const docInDb = findSingleResult.value;\n                if (\n                    docInDb &&\n                    (\n                        !docInDb._deleted ||\n                        withDeleted\n                    )\n                ) {\n                    ret.push(docInDb);\n                }\n            })\n        );\n        return ret;\n    }\n    query(preparedQuery: PreparedQuery<RxDocType>): Promise<RxStorageQueryResult<RxDocType>> {\n        return this.retryUntilNoWriteInBetween(\n            () => queryDenoKV(this, preparedQuery)\n        );\n    }\n    async count(preparedQuery: PreparedQuery<RxDocType>): Promise<RxStorageCountResult> {\n        /**\n         * At this point in time (end 2023), DenoKV does not support\n         * range counts. So we have to run a normal query and use the result set length.\n         * @link https://github.com/denoland/deno/issues/18965\n         */\n        const result = await this.retryUntilNoWriteInBetween(\n            () => this.query(preparedQuery)\n        );\n        return {\n            count: result.documents.length,\n            mode: 'fast'\n        };\n    }\n    getAttachmentData(documentId: string, attachmentId: string, digest: string): Promise<string> {\n        throw new Error(\"Method not implemented.\");\n    }\n    changeStream() {\n        return this.changes$.asObservable();\n    }\n    async cleanup(minimumDeletedTime: number): Promise<boolean> {\n        const maxDeletionTime = now() - minimumDeletedTime;\n        const kv = await this.kvPromise;\n        const index = CLEANUP_INDEX;\n        const indexName = getDenoKVIndexName(index);\n        const indexMeta = this.internals.indexes[indexName];\n        const lowerBoundString = getStartIndexStringFromLowerBound(\n            this.schema,\n            index,\n            [\n                true,\n                /**\n                 * Do not use 0 here,\n                 * because 1 is the minimum value for _meta.lwt\n                 */\n                1\n            ]\n        );\n        const upperBoundString = getStartIndexStringFromLowerBound(\n            this.schema,\n            index,\n            [\n                true,\n                maxDeletionTime\n            ]\n        );\n        let noMoreUndeleted: boolean = true;\n\n        const range = kv.list({\n            start: [this.keySpace, indexMeta.indexId, lowerBoundString],\n            end: [this.keySpace, indexMeta.indexId, upperBoundString]\n        }, {\n            consistency: this.settings.consistencyLevel,\n            batchSize: this.settings.batchSize,\n            limit: this.settings.batchSize\n        });\n\n        let rangeCount = 0;\n        for await (const row of range) {\n            rangeCount = rangeCount + 1;\n            const docId = row.value;\n            const docDataResult = await kv.get([this.keySpace, DENOKV_DOCUMENT_ROOT_PATH, docId], this.kvOptions);\n            if (!docDataResult.value) {\n                continue;\n            }\n            const docData = ensureNotFalsy(docDataResult.value);\n            if (\n                !docData._deleted ||\n                docData._meta.lwt > maxDeletionTime\n            ) {\n                continue;\n            }\n\n\n            let tx = kv.atomic();\n            tx = tx.check(docDataResult);\n            tx = tx.delete([this.keySpace, DENOKV_DOCUMENT_ROOT_PATH, docId]);\n            Object\n                .values(this.internals.indexes)\n                .forEach(indexMetaInner => {\n                    tx = tx.delete([this.keySpace, indexMetaInner.indexId, docId]);\n                });\n            await tx.commit();\n        }\n        return noMoreUndeleted;\n    }\n    async close(): Promise<void> {\n        if (this.closed) {\n            return this.closed;\n        }\n        this.closed = (async () => {\n            this.changes$.complete();\n            const kv = await this.kvPromise;\n            await kv.close();\n        })();\n        return this.closed;\n    }\n    async remove(): Promise<void> {\n        ensureNotClosed(this);\n        const kv = await this.kvPromise;\n        const range = kv.list({\n            start: [this.keySpace],\n            end: [this.keySpace, INDEX_MAX]\n        }, {\n            consistency: this.settings.consistencyLevel,\n            batchSize: this.settings.batchSize\n        });\n        let promises: Promise<any>[] = [];\n        for await (const row of range) {\n            promises.push(kv.delete(row.key));\n        }\n\n        await Promise.all(promises);\n        return this.close();\n    }\n    conflictResultionTasks(): Observable<RxConflictResultionTask<RxDocType>> {\n        return new Subject<any>().asObservable();\n    }\n    resolveConflictResultionTask(_taskSolution: RxConflictResultionTaskSolution<RxDocType>): Promise<void> {\n        return PROMISE_RESOLVE_VOID;\n    }\n}\n\n\n\nexport async function createDenoKVStorageInstance<RxDocType>(\n    storage: RxStorageDenoKV,\n    params: RxStorageInstanceCreationParams<RxDocType, DenoKVSettings>,\n    settings: DenoKVSettings\n): Promise<RxStorageInstanceDenoKV<RxDocType>> {\n    settings = flatClone(settings);\n    if (!settings.batchSize) {\n        settings.batchSize = 100;\n    }\n\n    const primaryPath = getPrimaryFieldOfPrimaryKey(params.schema.primaryKey);\n\n    const indexDBs: { [indexName: string]: DenoKVIndexMeta<RxDocType>; } = {};\n    const useIndexes = params.schema.indexes ? params.schema.indexes.slice(0) : [];\n    useIndexes.push([primaryPath]);\n    const useIndexesFinal = useIndexes.map(index => {\n        const indexAr = toArray(index);\n        return indexAr;\n    });\n    useIndexesFinal.push(CLEANUP_INDEX);\n    useIndexesFinal.forEach((indexAr, indexId) => {\n        const indexName = getDenoKVIndexName(indexAr);\n        indexDBs[indexName] = {\n            indexId: '|' + indexId + '|',\n            indexName,\n            getIndexableString: getIndexableStringMonad(params.schema, indexAr),\n            index: indexAr\n        };\n    });\n\n    const internals = {\n        indexes: indexDBs\n    };\n    const instance = new RxStorageInstanceDenoKV(\n        storage,\n        params.databaseName,\n        params.collectionName,\n        params.schema,\n        internals,\n        params.options,\n        settings\n    );\n\n    await addRxStorageMultiInstanceSupport(\n        RX_STORAGE_NAME_DENOKV,\n        params,\n        instance\n    );\n\n    return Promise.resolve(instance);\n}\n\n\n\nfunction ensureNotClosed(\n    instance: RxStorageInstanceDenoKV<any>\n) {\n    if (instance.closed) {\n        throw new Error('RxStorageInstanceDenoKV is closed ' + instance.databaseName + '-' + instance.collectionName);\n    }\n}\n"],"mappings":"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","ignoreList":[]}